(()=>{const e=document.getElementById("seeCanvas"),n=document.getElementById("colorPicker"),t=e.getContext("2d");let o=[];const l=document.getElementById("kanjiOptions");let i="",c=[],s=[],r=30,a=0,d={username:"",kanjiName:"",kanjiData:""},u={baseKanji:[],userKanji:[],leeway:0},g=!1;t.lineWidth=10;let f="",h="",m=0,p=0,k=[],E=[],y=[],v=[];var j=document.getElementById("myRange"),w=document.getElementById("demo");function L(e){i=e.toString(),console.log("fetched kanji from db"),console.log(i),console.log("loading")}function B(n,o){console.log("Pen down:",n-b(e).left,o-b(e).top),g=!0,t.beginPath(),t.moveTo(n-b(e).left,o-b(e).top),k.push(n-b(e).left),E.push(o-b(e).top)}function I(n,o){console.log("Pen move:",n-b(e).left,o-b(e).top),g&&(t.lineTo(n-b(e).left,o-b(e).top),t.stroke(),k.push(n-b(e).left),E.push(o-b(e).top))}function O(n){if(g){console.log("Pen up:",n.clientX-b(e).left,n.clientY-b(e).top),g=!1,m++,document.getElementById("usStrokes").innerHTML=m,k.push(n.clientX-b(e).left),E.push(n.clientY-b(e).top),console.log(k),console.log(E);for(var t=0;t<k.length;t++)y[t]=[k[t],E[t]];console.log("Total coordinates "+y),console.log("Coordinates remaining: "+y),v.push(y),console.log("added stroke "+m+" to the save data"),console.log(v),y=[],k=[],E=[]}}function b(e){const n=e.getBoundingClientRect();return{left:n.left+window.scrollX,top:n.top+window.scrollY}}function x(){console.log("reset drawing"),t.clearRect(0,0,e.width,e.height),m=0,v=[],document.getElementById("usStrokes").innerHTML=m,document.getElementById("result").innerHTML="currently drawing..."}function S(){console.log("setting coordinates for new kanji"),s=[],console.log("on string "+i),i.replace("\n","");let e=i.substring(9,i.length-1).split("<stroke> ");for(let n=0;n<e.length;n++){c=[];const t=e[n].split(",");console.log(t);for(let e=0;e<t.length;e+=2)c[e/2]=[t[e],t[e+1]];console.log(c),s.push(c)}console.log(s),p=s.length}function M(e){const n=new Request("hipy.py",{method:"POST",body:'{"action": "fetch", "state": '+JSON.stringify(e)+"}"});return fetch(n).then((function(e){if(e.ok)return e.json()})).then((function(e){return console.log(e),e}))}function T(e){let n=1e3,t=1e3,o=0,l=0,i=JSON.parse(JSON.stringify(e));return e.forEach((e=>{e.forEach((e=>{console.log("testing for minimum with "+e[0]+" and "+e[1]+" against "+n+" and "+t),e[0]<n&&(console.log("found that "+e[0]+" was less than "+n+" and set new x minimum"),n=e[0]),e[1]<t&&(console.log("found that "+e[1]+" was less than "+t+" and set new y minimum"),t=e[1])}))})),i.forEach((e=>{e.forEach((e=>{e[0]-=n,e[1]-=t,e[0]>o&&(o=e[0]),e[1]>l&&(l=e[1])}))})),[i,o,n]}w.innerHTML=j.value,fetch("list.txt").then((function(e){if(e.ok)return e.text();throw new Error("Failed to load file")})).then((function(e){o=e.split("\n"),console.log(o);let n=Math.floor(Math.random()*o.length);n=5,document.getElementById("myKanji").src="complete_kanji/"+o[5],p=o[5].substring(o[5].indexOf("_")+1,o[5].indexOf(".")),console.log(o[5]),h=o[5].substring(0,o[5].indexOf("_")),d.kanjiName=h})).then((function(){l.innerHTML="",console.log("adding options for kanji selection");for(let e=0;e<o.length;e++){let n=o[e],t=document.createElement("option");t.textContent=n,t.value=n,l.appendChild(t),console.log("added "+t+" to dropdown options")}})),x(),S(),document.getElementById("username").value="",console.log("fetching kanji from db"),M("roku_4").then(L).then(S),j.oninput=function(){w.innerHTML=this.value,r=parseInt(this.value)},n.addEventListener("change",(e=>{t.strokeStyle=e.target.value})),e.addEventListener("pointerdown",(function(e){B(e.clientX,e.clientY)}),!1),e.addEventListener("pointermove",(function(e){e.pressure>0&&I(e.clientX,e.clientY)}),!1),e.addEventListener("pointerup",O),e.addEventListener("mouseout",O),e.addEventListener("touchstart",(function(e){console.log("finger touchie the screen woo"),e.preventDefault(),B(e.touches[0].clientX,e.touches[0].clientY)}),!1),e.addEventListener("touchmove",(function(e){e.pressure>0&&(console.log("finger movie the screen woo"),e.preventDefault(),I(e.touches[0].clientX,e.touches[0].clientY))}),!1),e.addEventListener("touchend",O),document.getElementById("login").addEventListener("click",(function(){f=document.getElementById("username").value,console.log("Set username to "+f),document.getElementById("curUser").innerHTML=f,d.username=f})),document.getElementById("submit").addEventListener("click",(function(){document.getElementById("result").innerHTML=m==p?"Stroke count matched!":"Stroke count incorrect.",a=0;let e=f+"-"+h+".txt";document.createElement("a");let n="";for(let e=0;e<v.length;e++)n=n+"<stroke> "+v[e]+"\n";console.log("Saved data "+e),function(e,n){e.forEach((e=>{e.forEach((e=>{e[0]=Math.round(e[0]),e[1]=Math.round(e[1])}))})),n.forEach((e=>{e.forEach((e=>{e[0]=Math.round(e[0]),e[1]=Math.round(e[1])}))})),console.log("scoring kanji"),console.log(e),console.log(n);let t=[],o=0,l=0;[t,o,l]=T(e),console.log("normalized first kanji"),console.log(t);let i=[],c=0,s=0;[i,c,s]=T(n),console.log("normalized second kanji"),console.log(i);let a=c/o,d=s/l;i.forEach((e=>{e.forEach((e=>{e[0]/=a,e[1]/=d}))})),u.baseKanji=t,u.userKanji=i,u.leeway=r,console.log("grading with a leniency of "+u.leeway),function(){const e=new Request("hipy.py",{method:"POST",body:'{"action": "grade", "state": '+JSON.stringify(u)+"}"});return fetch(e).then((function(e){if(e.ok)return e.json()})).then((function(e){return console.log(e),e}))}().then((e=>{document.getElementById("score").innerHTML=e[e.length-1].toFixed(2)+"%",console.log("set score")})),console.log("converting kanji to text");let g="";for(let n=0;n<e.length;n++)g=g+"<stroke> "+e[n]+"\n";let f="";for(let e=0;e<n.length;e++)f=f+"<stroke> "+n[e]+"\n";let h="";for(let e=0;e<t.length;e++)h=h+"<stroke> "+t[e]+"\n";let m="";for(let e=0;e<i.length;e++)m=m+"<stroke> "+i[e]+"\n";console.log("Here are the original kanji data"),console.log(g),console.log(f),console.log("and here are the normalized kanji data"),console.log(h),console.log(m)}(s,v),function(e){d.kanjiData=e;const n=new Request("hipy.py",{method:"POST",body:'{"action": "upload", "state": '+JSON.stringify(d)+"}"});fetch(n).then((function(e){if(e.ok)return e.json()})).then((function(e){console.log(e)}))}(n)})),document.getElementById("drawReset").addEventListener("click",x),l.addEventListener("change",(function(){console.log("changing selected kanji"),function(){console.log("Getting new kanji"),x();const e=l.value;var n;console.log("chose kanji "+e),n=e,document.getElementById("myKanji").src="complete_kanji/"+n,p=n.substring(n.indexOf("_")+1,n.indexOf(".")),console.log(n),console.log(n.substring(0,n.indexOf("."))),h=n.substring(0,n.indexOf("_")),d.kanjiName=h,M(n.substring(0,n.indexOf("."))).then(L).then(S)}()}))})();