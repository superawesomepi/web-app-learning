(()=>{const e=document.getElementById("seeCanvas"),n=document.getElementById("colorPicker"),t=e.getContext("2d");let o=[];const l=document.getElementById("kanjiOptions");let c="",i=[],s=[],r=0,a={username:"",kanjiName:"",kanjiData:""},d={baseKanji:[],userKanji:[],leeway:0},u=!1;t.lineWidth=10;let g="",f="",h=0,m=0,p=[],k=[],E=[],y=[];function j(e){c=e.toString(),console.log("fetched kanji from db"),console.log(c),console.log("loading")}function v(n,o){console.log("Pen down:",n-x(e).left,o-x(e).top),u=!0,t.beginPath(),t.moveTo(n-x(e).left,o-x(e).top),p.push(n-x(e).left),k.push(o-x(e).top)}function w(n,o){console.log("Pen move:",n-x(e).left,o-x(e).top),u&&(t.lineTo(n-x(e).left,o-x(e).top),t.stroke(),p.push(n-x(e).left),k.push(o-x(e).top))}function L(n){if(u){console.log("Pen up:",n.clientX-x(e).left,n.clientY-x(e).top),u=!1,h++,document.getElementById("usStrokes").innerHTML=h,p.push(n.clientX-x(e).left),k.push(n.clientY-x(e).top),console.log(p),console.log(k);for(var t=0;t<p.length;t++)E[t]=[p[t],k[t]];console.log("Total coordinates "+E),console.log("Coordinates remaining: "+E),y.push(E),console.log("added stroke "+h+" to the save data"),console.log(y),E=[],p=[],k=[]}}function x(e){const n=e.getBoundingClientRect();return{left:n.left+window.scrollX,top:n.top+window.scrollY}}function B(){console.log("reset drawing"),t.clearRect(0,0,e.width,e.height),h=0,y=[],document.getElementById("usStrokes").innerHTML=h,document.getElementById("result").innerHTML="currently drawing..."}function I(){console.log("setting coordinates for new kanji"),s=[],console.log("on string "+c),c.replace("\n","");let e=c.substring(9,c.length-1).split("<stroke> ");for(let n=0;n<e.length;n++){i=[];const t=e[n].split(",");console.log(t);for(let e=0;e<t.length;e+=2)i[e/2]=[t[e],t[e+1]];console.log(i),s.push(i)}console.log(s),m=s.length}function O(e){const n=new Request("hipy.py",{method:"POST",body:'{"action": "fetch", "state": '+JSON.stringify(e)+"}"});return fetch(n).then((function(e){if(e.ok)return e.json()})).then((function(e){return console.log(e),e}))}function b(e){let n=1e3,t=1e3,o=0,l=0,c=JSON.parse(JSON.stringify(e));return e.forEach((e=>{e.forEach((e=>{console.log("testing for minimum with "+e[0]+" and "+e[1]+" against "+n+" and "+t),e[0]<n&&(console.log("found that "+e[0]+" was less than "+n+" and set new x minimum"),n=e[0]),e[1]<t&&(console.log("found that "+e[1]+" was less than "+t+" and set new y minimum"),t=e[1])}))})),c.forEach((e=>{e.forEach((e=>{e[0]-=n,e[1]-=t,e[0]>o&&(o=e[0]),e[1]>l&&(l=e[1])}))})),[c,o,n]}fetch("list.txt").then((function(e){if(e.ok)return e.text();throw new Error("Failed to load file")})).then((function(e){o=e.split("\n"),console.log(o);let n=Math.floor(Math.random()*o.length);n=5,document.getElementById("myKanji").src="complete_kanji/"+o[5],m=o[5].substring(o[5].indexOf("_")+1,o[5].indexOf(".")),console.log(o[5]),f=o[5].substring(0,o[5].indexOf("_")),a.kanjiName=f})).then((function(){l.innerHTML="",console.log("adding options for kanji selection");for(let e=0;e<o.length;e++){let n=o[e],t=document.createElement("option");t.textContent=n,t.value=n,l.appendChild(t),console.log("added "+t+" to dropdown options")}})),B(),I(),document.getElementById("username").value="",console.log("fetching kanji from db"),O("roku_4").then(j).then(I),n.addEventListener("change",(e=>{t.strokeStyle=e.target.value})),e.addEventListener("pointerdown",(function(e){v(e.clientX,e.clientY)}),!1),e.addEventListener("pointermove",(function(e){e.pressure>0&&w(e.clientX,e.clientY)}),!1),e.addEventListener("pointerup",L),e.addEventListener("mouseout",L),e.addEventListener("touchstart",(function(e){console.log("finger touchie the screen woo"),e.preventDefault(),v(e.touches[0].clientX,e.touches[0].clientY)}),!1),e.addEventListener("touchmove",(function(e){e.pressure>0&&(console.log("finger movie the screen woo"),e.preventDefault(),w(e.touches[0].clientX,e.touches[0].clientY))}),!1),e.addEventListener("touchend",L),document.getElementById("login").addEventListener("click",(function(){g=document.getElementById("username").value,console.log("Set username to "+g),document.getElementById("curUser").innerHTML=g,a.username=g})),document.getElementById("submit").addEventListener("click",(function(){document.getElementById("result").innerHTML=h==m?"Stroke count matched!":"Stroke count incorrect.",r=0;let e=g+"-"+f+".txt";const n=document.createElement("a");let t="";for(let e=0;e<y.length;e++)t=t+"<stroke> "+y[e]+"\n";n.href="data:text/plain;charset=utf-8,"+encodeURIComponent(t),n.download=e,n.click(),console.log("Saved data "+e),function(e,n){e.forEach((e=>{e.forEach((e=>{e[0]=Math.round(e[0]),e[1]=Math.round(e[1])}))})),n.forEach((e=>{e.forEach((e=>{e[0]=Math.round(e[0]),e[1]=Math.round(e[1])}))})),console.log("scoring kanji"),console.log(e),console.log(n);let t=[],o=0,l=0;[t,o,l]=b(e),console.log("normalized first kanji"),console.log(t);let c=[],i=0,s=0;[c,i,s]=b(n),console.log("normalized second kanji"),console.log(c);let r=i/o,a=s/l;c.forEach((e=>{e.forEach((e=>{e[0]/=r,e[1]/=a}))})),d.baseKanji=t,d.userKanji=c,d.leeway=50,function(){const e=new Request("hipy.py",{method:"POST",body:'{"action": "grade", "state": '+JSON.stringify(d)+"}"});return fetch(e).then((function(e){if(e.ok)return e.json()})).then((function(e){return console.log(e),e}))}().then((e=>{document.getElementById("score").innerHTML=e[e.length-1].toFixed(2)+"%",console.log("set score")})),console.log("converting kanji to text");let u="";for(let n=0;n<e.length;n++)u=u+"<stroke> "+e[n]+"\n";let g="";for(let e=0;e<n.length;e++)g=g+"<stroke> "+n[e]+"\n";let f="";for(let e=0;e<t.length;e++)f=f+"<stroke> "+t[e]+"\n";let h="";for(let e=0;e<c.length;e++)h=h+"<stroke> "+c[e]+"\n";console.log("Here are the original kanji data"),console.log(u),console.log(g),console.log("and here are the normalized kanji data"),console.log(f),console.log(h)}(s,y),function(e){a.kanjiData=e;const n=new Request("hipy.py",{method:"POST",body:'{"action": "upload", "state": '+JSON.stringify(a)+"}"});fetch(n).then((function(e){if(e.ok)return e.json()})).then((function(e){console.log(e)}))}(t)})),document.getElementById("drawReset").addEventListener("click",B),l.addEventListener("change",(function(){console.log("changing selected kanji"),function(){console.log("Getting new kanji"),B();const e=l.value;var n;console.log("chose kanji "+e),n=e,document.getElementById("myKanji").src="complete_kanji/"+n,m=n.substring(n.indexOf("_")+1,n.indexOf(".")),console.log(n),console.log(n.substring(0,n.indexOf("."))),f=n.substring(0,n.indexOf("_")),a.kanjiName=f,O(n.substring(0,n.indexOf("."))).then(j).then(I)}()}))})();